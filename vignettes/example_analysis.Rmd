---
title: "Example Analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Example Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
if(!require(opencodes)) remotes::install_github("bennettoxford/opencodes")
library(opencodes)
library(tidyverse)
```

```{r}
# Import the codelist
icd10_xix_codelist <- get_codelist("opensafely/icd-10-chapter-xix/4dce479b/")
```

```{r}
# Filter ICD-10 code usage to codes contained in the
# ICD-10 Chapter XIX codelist and years 2014 to 2024
injury_data <- icd10_usage |>
  filter(icd10_code %in% icd10_xix_codelist$code) |>
  filter(year(start_date) >= 2014 & year(start_date) < 2024)

# Calculate proportional usage for each code 
# and select ten most frequently used codes
top10_injury_codes <- injury_data |> 
  group_by(icd10_code, description) |>
  summarise(usage = sum(usage), .groups = "drop") |>
  mutate(prop_usage = usage/ sum(usage)) |>
  slice_max(prop_usage, n = 10) |>
  pull(icd10_code)
```

```{r}
# Visualise the time trends for the ten selected codes
injury_data |>
  filter(icd10_code %in% top10_injury_codes) |>
  ggplot(aes(x = year(end_date), y = usage, group = icd10_code, color = description)) +
  geom_line() +
  geom_point() +
  ggrepel::geom_text_repel(
    data = injury_data |>
      filter(icd10_code %in% top10_injury_codes) |>
      filter(end_date == max(end_date)),
    aes(x = year(end_date),
        y = usage,
        color = description,
        label = str_wrap(paste(icd10_code,":", description), width = 20)),
    lineheight = 0.8,
    hjust = 1,
    segment.color = 'dark grey',
    segment.linetype = 2,
    direction = "y",
    nudge_x = 1.5,
    size = 2.5,
    box.padding = .3) +
  scale_y_continuous(labels = scales::comma) +
  scale_x_continuous(breaks = seq(min(year(injury_data$end_date)), max(year(injury_data$end_date)), by = 1)) +
  labs(x = "", y = "Usage count", color = "ICD-10 code") +
  theme_light() +
  theme(legend.position = "none")

```



